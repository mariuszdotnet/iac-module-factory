# Bicep Module CI - Lint and Build Validation
# Runs on pull requests to validate changed Bicep modules

name: CI - Bicep Module Validation

on:
  workflow_dispatch:
    inputs:
      module_path:
        description: 'Module path to validate (e.g., modules/Microsoft.Web/sites/web-app)'
        required: false
        type: string
  pull_request:
    branches:
      - main
    paths:
      - 'modules/**'
      - 'bicepconfig.json'
      - '.github/workflows/ci.yml'

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for OIDC authentication with Azure

jobs:
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.detect.outputs.modules }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: detect
        run: |
          set -e
          
          MODULES=""
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input or validate all
            if [ -n "${{ inputs.module_path }}" ]; then
              MODULE_PATH="${{ inputs.module_path }}"
              if [ -f "$MODULE_PATH/main.bicep" ]; then
                MODULES="$MODULE_PATH"
              else
                echo "âŒ Module not found: $MODULE_PATH"
                exit 1
              fi
            else
              # No input provided - find all modules (exclude examples)
              MODULES=$(find modules -path "*/examples" -prune -o -name "main.bicep" -type f -print | grep -v "/examples/" | grep -v "/tests/" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
            fi
          else
            # Pull request - detect changed files
            echo "ğŸ” Detecting changed files in PR..."
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
            
            echo "Changed files:"
            echo "$CHANGED_FILES"
            
            # Extract unique module paths from changed files (only main module, not examples/tests)
            for FILE in $CHANGED_FILES; do
              if [[ "$FILE" == modules/* ]]; then
                # Skip examples and tests directories
                if [[ "$FILE" == */examples/* ]] || [[ "$FILE" == */tests/* ]]; then
                  continue
                fi
                
                # Find the module root (directory containing main.bicep)
                DIR=$(dirname "$FILE")
                while [ "$DIR" != "modules" ] && [ "$DIR" != "." ]; do
                  if [ -f "$DIR/main.bicep" ]; then
                    MODULES="$MODULES $DIR"
                    break
                  fi
                  DIR=$(dirname "$DIR")
                done
              fi
            done
            
            # Remove duplicates
            MODULES=$(echo "$MODULES" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          fi
          
          # Trim whitespace
          MODULES=$(echo "$MODULES" | xargs)
          
          if [ -z "$MODULES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "modules=" >> $GITHUB_OUTPUT
            echo "âš ï¸ No module changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "modules=$MODULES" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Modules to validate: $MODULES"
          fi

  validate:
    name: Lint and Build Modules
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Bicep CLI
        run: |
          az bicep install
          az bicep version

      - name: Validate Changed Modules
        id: validate
        run: |
          set -e
          
          MODULES="${{ needs.detect-changes.outputs.modules }}"
          
          echo "ğŸ” Validating changed modules..."
          echo "Modules: $MODULES"
          
          TOTAL=0
          PASSED=0
          FAILED=0
          FAILED_MODULES=""
          
          for MODULE_DIR in $MODULES; do
            MODULE="$MODULE_DIR/main.bicep"
            
            if [ ! -f "$MODULE" ]; then
              echo "âš ï¸ Skipping $MODULE_DIR - main.bicep not found"
              continue
            fi
            
            TOTAL=$((TOTAL + 1))
            MODULE_NAME=$(echo "$MODULE_DIR" | sed 's|modules/||')
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Validating: $MODULE_NAME"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Run bicep build (syntax validation)
            echo "ğŸ”¨ Building..."
            if az bicep build --file "$MODULE" --stdout > /dev/null 2>&1; then
              echo "âœ… Build: PASSED"
              BUILD_RESULT="passed"
            else
              echo "âŒ Build: FAILED"
              az bicep build --file "$MODULE" 2>&1 || true
              BUILD_RESULT="failed"
            fi
            
            # Run bicep lint (linting rules from bicepconfig.json)
            echo "ğŸ” Linting..."
            LINT_OUTPUT=$(az bicep lint --file "$MODULE" 2>&1) || true
            
            # Check for errors in lint output
            if echo "$LINT_OUTPUT" | grep -q "Error"; then
              echo "âŒ Lint: FAILED"
              echo "$LINT_OUTPUT"
              LINT_RESULT="failed"
            else
              echo "âœ… Lint: PASSED"
              # Show warnings if any
              if echo "$LINT_OUTPUT" | grep -q "Warning"; then
                echo "âš ï¸ Warnings:"
                echo "$LINT_OUTPUT" | grep "Warning" || true
              fi
              LINT_RESULT="passed"
            fi
            
            # Track results
            if [ "$BUILD_RESULT" = "passed" ] && [ "$LINT_RESULT" = "passed" ]; then
              PASSED=$((PASSED + 1))
            else
              FAILED=$((FAILED + 1))
              FAILED_MODULES="$FAILED_MODULES\n  - $MODULE_NAME"
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Validation Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total modules: $TOTAL"
          echo "âœ… Passed: $PASSED"
          echo "âŒ Failed: $FAILED"
          
          if [ $FAILED -gt 0 ]; then
            echo ""
            echo "Failed modules:"
            echo -e "$FAILED_MODULES"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ All modules validated successfully!"

      - name: Comment on PR (on failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Bicep Module Validation Failed**\n\nOne or more modules failed lint or build validation. Please check the workflow logs for details.'
            })
